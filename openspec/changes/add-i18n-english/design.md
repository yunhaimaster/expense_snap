# Design: Internationalization Architecture

## Context

Expense Snap is a Flutter expense tracking app with ~400+ hardcoded Chinese strings. The app uses Provider for state management and follows Clean Architecture. Current dependencies already include `flutter_localizations` and `intl` but they're unused for app strings.

**Stakeholders**: End users (corporate employees), app developers
**Constraints**:
- Offline-first: translations must work without network
- Minimal bundle size impact
- Preserve existing Chinese UX exactly
- No breaking changes to data/exports for existing users

## Goals / Non-Goals

**Goals:**
- Support English (EN) and Traditional Chinese (ZH-HK) UI
- System language auto-detection with manual override
- Locale-aware date/number formatting
- Localized export filenames
- Extensible infrastructure for future languages

**Non-Goals:**
- RTL support (Arabic, Hebrew) - requires layout changes
- Plural/gender grammatical forms - minimal need for expense app
- Dynamic language loading - both languages bundled

## Decisions

### Decision 1: Use Flutter's Official `intl` + ARB Files

**Choice**: Flutter `gen-l10n` with ARB (Application Resource Bundle) files

**Alternatives considered**:
| Approach | Pros | Cons |
|----------|------|------|
| `intl` + ARB (chosen) | Flutter official, IDE support, compile-time safety | More boilerplate |
| `easy_localization` | Simple API, JSON files | Extra dependency, less type-safe |
| `slang` | Type-safe, code generation | Different paradigm, learning curve |
| Hardcoded maps | No dependencies | No tooling, error-prone |

**Rationale**: Flutter's official solution provides:
- Compile-time string key validation
- IDE autocomplete for `S.of(context).stringKey`
- ARB format is industry standard for translation services
- Zero additional dependencies (already have `intl`)

### Decision 2: Locale-Aware Formatters

**Choice**: Create `LocalizedFormatters` class that takes `Locale` parameter

```dart
// Before: Hardcoded Chinese
static final DateFormat _monthFormatter = DateFormat('yyyy年M月');

// After: Locale-aware
static String formatMonth(DateTime date, Locale locale) {
  final format = locale.languageCode == 'zh'
    ? DateFormat('yyyy年M月', 'zh_HK')
    : DateFormat('MMMM yyyy', 'en');
  return format.format(date);
}
```

**Rationale**:
- `intl` package handles locale-specific date/number patterns
- Explicit locale parameter makes testing deterministic
- Fallback to English for unknown locales

### Decision 3: Export Filename Localization

**Choice**: Parameterize export filename format based on locale

| Locale | Filename Pattern |
|--------|-----------------|
| ZH-HK | `報銷單_2025年01月_{name}.xlsx` |
| EN | `Expense_Report_2025-01_{name}.xlsx` |

**Rationale**:
- Chinese users expect Chinese filenames (backward compatible)
- English users get readable filenames
- `{name}` placeholder uses user's configured name

### Decision 4: Language Selection UX

**Choice**: 3-tier cascade with manual override

```
1. User preference (Settings) - if set
2. System locale - if supported
3. Fallback: Traditional Chinese (ZH-HK)
```

**Rationale**:
- Respects user choice first
- Auto-detects for new users
- Falls back to Hong Kong Chinese (no behavior change for existing users)

### Decision 5: String Organization in ARB

**Choice**: Flat structure with prefixed keys by screen/feature

```json
{
  "homeTitle": "Expenses",
  "homeMonthSummary": "{count} expenses this month",
  "settingsTitle": "Settings",
  "settingsLanguage": "Language",
  "errorNoConnection": "Please check your network connection",
  "exportFilename": "Expense_Report_{month}_{name}"
}
```

**Rationale**:
- Prefix by screen aids navigation (`home*`, `settings*`, `export*`)
- Flat structure works well with Flutter's `gen-l10n`
- Placeholders use `{name}` ICU syntax

## Architecture

```
project_root/
├── l10n.yaml                       # gen-l10n configuration (Flutter convention: project root)
├── lib/
│   ├── l10n/
│   │   ├── app_en.arb              # English translations
│   │   └── app_zh.arb              # Chinese translations (source of truth)
│   ├── generated/
│   │   └── app_localizations.dart  # Generated by flutter gen-l10n (do not edit)
│   ├── core/
│   │   └── utils/
│   │       └── formatters.dart     # Updated: locale-aware methods
│   └── presentation/
│       └── providers/
│           └── locale_provider.dart    # NEW: language preference state
```

**Note**: `l10n.yaml` must be in project root per Flutter convention. Generated code goes to `lib/generated/` via `output-dir` config.

### Provider Integration

```dart
class LocaleProvider extends ChangeNotifier {
  Locale _locale = const Locale('zh', 'HK'); // Default fallback
  final SettingsRepository _settingsRepo;

  LocaleProvider(this._settingsRepo);

  Locale get locale => _locale;

  /// 初始化時從儲存載入偏好，否則用系統語言
  Future<void> initialize() async {
    final saved = await _settingsRepo.getLocalePreference();
    if (saved != null) {
      _locale = saved;
    } else {
      // 檢測系統語言
      final systemLocale = PlatformDispatcher.instance.locale;
      _locale = _supportedLocales.contains(systemLocale.languageCode)
          ? systemLocale
          : const Locale('zh', 'HK'); // Fallback
    }
    notifyListeners();
  }

  Future<void> setLocale(Locale newLocale) async {
    if (_locale == newLocale) return;
    _locale = newLocale;
    await _settingsRepo.saveLocalePreference(newLocale);
    notifyListeners();
  }

  static const _supportedLocales = ['en', 'zh'];
}
```

### MaterialApp Configuration

```dart
MaterialApp(
  locale: context.watch<LocaleProvider>().locale,
  supportedLocales: const [
    Locale('en'),
    Locale('zh', 'HK'),
  ],
  localizationsDelegates: [
    AppLocalizations.delegate,
    GlobalMaterialLocalizations.delegate,
    GlobalWidgetsLocalizations.delegate,
    GlobalCupertinoLocalizations.delegate,
  ],
  // ...
)
```

## Risks / Trade-offs

| Risk | Mitigation |
|------|------------|
| Missing translations at runtime | ARB compile-time validation + fallback to key name |
| Bundle size increase | ARB files are ~10-20KB compressed, negligible |
| String key typos | `gen-l10n` provides compile-time checks |
| Date format inconsistency | Centralized `LocalizedFormatters` class |
| Export filename breaks existing workflows | ZH-HK default preserves backward compatibility |

## Migration Plan

### Phase 1: Infrastructure (non-breaking)
1. Add `l10n.yaml` configuration
2. Create `app_zh.arb` with all existing Chinese strings
3. Add `LocaleProvider` (default ZH-HK)
4. Generate `AppLocalizations` class

### Phase 2: String Extraction (file by file)
1. Start with isolated screens (Settings, Export)
2. Move to shared widgets
3. Complete with Home and Add Expense screens
4. Each PR: extract strings + verify tests pass

### Phase 3: English Translation
1. Create `app_en.arb` by translating `app_zh.arb`
2. Add language selector to Settings
3. Test all screens in English

### Phase 4: Locale-Aware Formatting
1. Update `Formatters` class methods
2. Update export filename generation
3. Verify exports in both languages

## Testing Strategy

- **Unit tests**: `LocaleProvider` state management
- **Widget tests**: String rendering with different locales
- **Integration tests**: Export with both language settings
- **Manual QA**: Full app walkthrough in EN and ZH-HK

## Resolved Decisions (formerly Open Questions)

1. **Currency name in exports**: ✅ **RESOLVED - Yes**
   - Excel column headers will be localized for consistency
   - Added to spec as "Localized Excel Content" requirement

2. **OCR result language**: ✅ **RESOLVED - No**
   - OCR detects receipt language regardless of UI locale
   - This preserves accuracy (receipts may be in any language)
   - Added to proposal as explicit non-change to `receipt-ocr` spec

3. **Onboarding language**: ✅ **RESOLVED - Auto-detect with selector**
   - Auto-detect from system locale on first launch
   - Language selector available in Settings for override
   - Added to spec as "Language Auto-Detection" requirement
